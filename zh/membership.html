<!doctype html>
<html lang="zh-Hans">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="开始 Churomi 会员并进入 Stripe 结算。">
    <title>Churomi — 会员</title>
    <link rel="icon" type="image/png" sizes="16x16" href="../assets/churomi-16.png">
    <link rel="icon" type="image/png" sizes="32x32" href="../assets/churomi-32.png">
    <link rel="icon" type="image/png" sizes="48x48" href="../assets/churomi-48.png">
    <link rel="apple-touch-icon" href="../assets/churomi-128.png">
    <link rel="stylesheet" href="../styles.css">
  </head>
  <body>
    <a class="skip-link" href="#main">跳到主要内容</a>
    <header class="header">
      <div class="container header__inner">
        <a class="brand" aria-label="Churomi" href="./index.html">
          <div class="brand__mark" aria-hidden="true">
            <img src="../assets/churomi-48.png" alt="" width="34" height="34">
          </div>
          <span class="brand__name">Churomi</span>
        </a>

        <div class="header__right">
          <nav class="nav" aria-label="Primary">
            <a class="nav__link" href="./index.html#features">功能</a>
            <a class="nav__link" href="./index.html#install">安装</a>
            <a class="nav__link" href="./membership.html" aria-current="page">会员</a>
            <a class="nav__link" href="./index.html#support">支持</a>
            <a class="nav__link" href="./privacy.html">隐私</a>
            <a class="nav__link" href="./terms.html">条款</a>
          </nav>

          <div class="lang" aria-label="Language">
            <a class="lang__link" href="../membership.html">EN</a>
            <a class="lang__link lang__link--active" href="./membership.html" aria-current="page">简体中文</a>
          </div>
        </div>
      </div>
    </header>

    <main id="main">
      <section class="section">
        <div class="container">
          <div class="auth">
            <div class="auth__copy">
              <p class="hero__eyebrow">会员</p>
              <h1 class="hero__title">开始你的 Churomi 会员</h1>
              <p class="hero__subtitle">
                登录（或创建账号）后进入 Stripe 结算。付款完成后，安装扩展并使用相同邮箱登录即可使用。
              </p>

              <div class="pricing" aria-label="会员价格">
                <div class="pricing__top">
                  <div class="pricing__label">按月订阅</div>
                  <div class="pricing__price">
                    <span class="pricing__amount">CAD 30</span>
                    <span class="pricing__period">/ 月</span>
                  </div>
                </div>
                <ul class="pricing__bullets">
                  <li>隐藏活动 + 隐身模式</li>
                  <li>切换标签页时保持支持页面活跃</li>
                  <li>在扩展菜单中管理账单</li>
                </ul>
                <p class="pricing__note">可选自动续订，最终价格以结算页为准。</p>
              </div>

              <div class="trust" aria-label="信任与政策">
                <div class="trust__row">
                  <span class="trust__item">Stripe 安全支付</span>
                  <span class="trust__sep" aria-hidden="true">•</span>
                  <span class="trust__item">随时可取消</span>
                  <span class="trust__sep" aria-hidden="true">•</span>
                  <a class="trust__link" href="https://chromewebstore.google.com/detail/churomi/oolnblmnhadiikagmhoahdaoiednoodk" target="_blank" rel="noopener noreferrer">Chrome 商店页面</a>
                </div>
              </div>
            </div>

            <div class="auth__panel">
              <div class="card">
                <div class="card__header">
                  <div class="pill">
                    <span class="pill__dot" aria-hidden="true"></span>
                    <span>结算</span>
                  </div>
                  <div class="pill pill--soft" id="authStatus">未登录</div>
                </div>
                <div class="card__body">
                  <div class="tabs" role="tablist" aria-label="认证方式">
                    <button class="tab tab--active" type="button" id="tabSignIn" aria-controls="panelSignIn" aria-selected="true">登录</button>
                    <button class="tab" type="button" id="tabSignUp" aria-controls="panelSignUp" aria-selected="false">注册</button>
                  </div>

                  <div id="panelSignIn" class="panel" role="tabpanel" aria-labelledby="tabSignIn">
                    <form id="signInForm" class="form">
                      <label class="field">
                        <span class="field__label">邮箱</span>
                        <input class="input" type="email" name="email" autocomplete="email" required>
                      </label>
                      <label class="field">
                        <span class="field__label">密码</span>
                        <input class="input" type="password" name="password" autocomplete="current-password" minlength="6" required>
                      </label>
                      <div class="form__actions">
                        <button class="btn btn--primary" type="submit" id="btnSignIn">继续</button>
                        <button class="btn btn--ghost" type="button" id="btnForgot">重置密码</button>
                      </div>
                      <div class="msg" id="signInMsg" role="status" aria-live="polite"></div>
                    </form>
                  </div>

                  <div id="panelSignUp" class="panel" role="tabpanel" aria-labelledby="tabSignUp" hidden>
                    <form id="signUpForm" class="form">
                      <label class="field">
                        <span class="field__label">邮箱</span>
                        <input class="input" type="email" name="email" autocomplete="email" required>
                      </label>
                      <label class="field">
                        <span class="field__label">密码</span>
                        <input class="input" type="password" name="password" autocomplete="new-password" minlength="6" required>
                      </label>
                      <div class="form__actions">
                        <button class="btn btn--primary" type="submit" id="btnSignUp">注册并发送验证邮件</button>
                      </div>
                      <div class="msg" id="signUpMsg" role="status" aria-live="polite"></div>
                    </form>
                  </div>

                  <div class="verify" id="verifyBox" hidden>
                    <p class="muted" style="margin: 0 0 10px;">
                      你的邮箱尚未验证。请先查收邮箱完成验证，然后返回重新登录。
                    </p>
                    <button class="btn btn--soft" type="button" id="btnResendVerify">重新发送验证邮件</button>
                    <div class="msg" id="verifyMsg" role="status" aria-live="polite"></div>
                  </div>

                  <div class="checkout" id="checkoutBox" hidden>
                    <label class="check">
                      <input type="checkbox" id="autoRenew" checked>
                      <span>按月自动续订（推荐）</span>
                    </label>
                    <button class="btn btn--primary" type="button" id="btnCheckout">打开 Stripe 结算</button>
                    <div class="msg" id="checkoutMsg" role="status" aria-live="polite"></div>
                    <p class="muted" style="margin: 10px 0 0; font-size: 13px;">
                      将跳转到 Stripe。付款完成后安装扩展并使用相同邮箱登录，然后点击 <b>刷新</b> 更新会员状态。
                    </p>
                  </div>
                </div>
                <div class="card__footer">
                  需要帮助？请邮件联系 <a href="mailto:churomi.app@gmail.com">churomi.app@gmail.com</a>。
                </div>
              </div>
            </div>
          </div>
        </div>
      </section>
    </main>

    <footer class="footer">
      <div class="container footer__inner" style="border-top: none;">
        <p class="muted">© <span id="year">2026</span> Churomi</p>
        <p class="footer__links">
          <a href="./privacy.html">隐私</a>
          <a href="./terms.html">条款</a>
        </p>
      </div>
    </footer>

    <script>
      document.getElementById("year").textContent = String(new Date().getFullYear());

      const FIREBASE_API_KEY = "AIzaSyARbeEdX9o6qitX0YW2w-OkxrZPutSP7JM";
      const API_BASE = "https://api.churomi.com";

      const $ = (id) => document.getElementById(id);
      const els = {
        authStatus: $("authStatus"),
        tabSignIn: $("tabSignIn"),
        tabSignUp: $("tabSignUp"),
        panelSignIn: $("panelSignIn"),
        panelSignUp: $("panelSignUp"),
        signInForm: $("signInForm"),
        signUpForm: $("signUpForm"),
        btnForgot: $("btnForgot"),
        signInMsg: $("signInMsg"),
        signUpMsg: $("signUpMsg"),
        verifyBox: $("verifyBox"),
        btnResendVerify: $("btnResendVerify"),
        verifyMsg: $("verifyMsg"),
        checkoutBox: $("checkoutBox"),
        autoRenew: $("autoRenew"),
        btnCheckout: $("btnCheckout"),
        checkoutMsg: $("checkoutMsg"),
      };

      const setMsg = (el, text, kind) => {
        if (!el) return;
        el.textContent = text || "";
        el.dataset.kind = kind || "";
      };

      const getDeviceId = () => {
        try {
          const key = "churomi_device_id";
          const existing = localStorage.getItem(key);
          if (existing) return existing;
          const created = crypto.randomUUID ? crypto.randomUUID() : String(Date.now()) + Math.random().toString(16).slice(2);
          localStorage.setItem(key, created);
          return created;
        } catch {
          return "web-" + String(Date.now());
        }
      };

      const firebasePost = async (method, body) => {
        const res = await fetch(`https://identitytoolkit.googleapis.com/v1/${method}?key=${encodeURIComponent(FIREBASE_API_KEY)}`, {
          method: "POST",
          headers: { "content-type": "application/json" },
          body: JSON.stringify(body),
        });
        const data = await res.json().catch(() => ({}));
        if (!res.ok) throw new Error(data?.error?.message || data?.error || `${method} ${res.status}`);
        return data;
      };

      const lookupEmailVerified = async (idToken) => {
        const data = await firebasePost("accounts:lookup", { idToken });
        const users = Array.isArray(data?.users) ? data.users : [];
        const user = users[0] || {};
        return Boolean(user.emailVerified);
      };

      const sendEmailVerification = async (idToken) => firebasePost("accounts:sendOobCode", { requestType: "VERIFY_EMAIL", idToken });
      const sendPasswordReset = async (email) => firebasePost("accounts:sendOobCode", { requestType: "PASSWORD_RESET", email });

      const setSignedIn = (auth) => {
        window.__auth = auth || null;
        els.authStatus.textContent = auth?.email ? `已登录：${auth.email}` : "未登录";
        els.checkoutBox.hidden = !auth;
      };

      const showPanel = (mode) => {
        const isSignIn = mode === "signin";
        els.tabSignIn.classList.toggle("tab--active", isSignIn);
        els.tabSignUp.classList.toggle("tab--active", !isSignIn);
        els.tabSignIn.setAttribute("aria-selected", String(isSignIn));
        els.tabSignUp.setAttribute("aria-selected", String(!isSignIn));
        els.panelSignIn.hidden = !isSignIn;
        els.panelSignUp.hidden = isSignIn;
        els.verifyBox.hidden = true;
        setMsg(els.signInMsg, "");
        setMsg(els.signUpMsg, "");
        setMsg(els.verifyMsg, "");
      };

      els.tabSignIn.addEventListener("click", () => showPanel("signin"));
      els.tabSignUp.addEventListener("click", () => showPanel("signup"));

      els.signInForm.addEventListener("submit", async (e) => {
        e.preventDefault();
        els.verifyBox.hidden = true;
        setMsg(els.signInMsg, "正在登录…");
        try {
          const fd = new FormData(els.signInForm);
          const email = String(fd.get("email") || "").trim();
          const password = String(fd.get("password") || "");
          const auth = await firebasePost("accounts:signInWithPassword", { email, password, returnSecureToken: true });
          const verified = await lookupEmailVerified(auth.idToken);
          if (!verified) {
            setSignedIn(null);
            els.verifyBox.hidden = false;
            window.__pendingVerify = { idToken: auth.idToken };
            setMsg(els.signInMsg, "需要邮箱验证。", "warn");
            return;
          }
          setSignedIn({ idToken: auth.idToken, email: auth.email });
          setMsg(els.signInMsg, "已登录，可以结算。", "ok");
        } catch (err) {
          setSignedIn(null);
          setMsg(els.signInMsg, err?.message || "登录失败。", "err");
        }
      });

      els.signUpForm.addEventListener("submit", async (e) => {
        e.preventDefault();
        setMsg(els.signUpMsg, "正在注册…");
        try {
          const fd = new FormData(els.signUpForm);
          const email = String(fd.get("email") || "").trim();
          const password = String(fd.get("password") || "");
          const auth = await firebasePost("accounts:signUp", { email, password, returnSecureToken: true });
          await sendEmailVerification(auth.idToken);
          setMsg(els.signUpMsg, "已发送验证邮件。验证后请切换到“登录”。", "ok");
        } catch (err) {
          setMsg(els.signUpMsg, err?.message || "注册失败。", "err");
        }
      });

      els.btnForgot.addEventListener("click", async () => {
        setMsg(els.signInMsg, "");
        const email = String(new FormData(els.signInForm).get("email") || "").trim();
        if (!email) return setMsg(els.signInMsg, "请先填写邮箱，然后点击“重置密码”。", "warn");
        setMsg(els.signInMsg, "正在发送重置邮件…");
        try {
          await sendPasswordReset(email);
          setMsg(els.signInMsg, "已发送重置密码邮件。", "ok");
        } catch (err) {
          setMsg(els.signInMsg, err?.message || "发送失败。", "err");
        }
      });

      els.btnResendVerify.addEventListener("click", async () => {
        setMsg(els.verifyMsg, "正在重新发送…");
        try {
          const idToken = window.__pendingVerify?.idToken;
          if (!idToken) throw new Error("请重新登录。");
          await sendEmailVerification(idToken);
          setMsg(els.verifyMsg, "已发送验证邮件，请检查收件箱/垃圾邮件。", "ok");
        } catch (err) {
          setMsg(els.verifyMsg, err?.message || "发送失败。", "err");
        }
      });

      els.btnCheckout.addEventListener("click", async () => {
        setMsg(els.checkoutMsg, "正在创建结算会话…");
        try {
          const idToken = window.__auth?.idToken;
          if (!idToken) throw new Error("请先登录。");
          const res = await fetch(`${API_BASE}/api/billing/checkout`, {
            method: "POST",
            headers: {
              "content-type": "application/json",
              "authorization": `Bearer ${idToken}`,
              "x-device-id": getDeviceId(),
            },
            body: JSON.stringify({ auto_renew: Boolean(els.autoRenew.checked) }),
          });
          const data = await res.json().catch(() => ({}));
          if (!res.ok) throw new Error(data?.error || `结算失败 (${res.status})`);
          if (!data?.url) throw new Error("缺少 Stripe 结算链接。");
          setMsg(els.checkoutMsg, "正在跳转…", "ok");
          location.href = data.url;
        } catch (err) {
          setMsg(els.checkoutMsg, err?.message || "结算失败。", "err");
        }
      });

      showPanel("signin");
    </script>
  </body>
</html>

